<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Owner Fleet</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select, button { padding: 8px; margin-right: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f5f5f5; }
    .badge { padding: 2px 8px; border-radius: 10px; display: inline-block; }
    #msg { margin-top: 10px; padding: 8px; }
    .ok { background: #e8fff0; border: 1px solid #b7f0cc; }
    .err { background: #ffecec; border: 1px solid #ffb3b3; }
  </style>
</head>
<body>
  <h2>Owner Fleet Management</h2>

  <h3>Add Truck</h3>
  <div>
    <input id="truckId" placeholder="truck-201" />
    <select id="truckType">
      <option value="pickup">pickup</option>
      <option value="box">box</option>
      <option value="semi">semi</option>
    </select>
    <select id="truckStatus">
      <option value="available">available</option>
      <option value="out_of_service">out_of_service</option>
      <option value="unavailable">unavailable</option>
    </select>
    <button id="addBtn">Add</button>
  </div>

  <h3>Trucks</h3>
  <button id="refreshBtn">Refresh</button>
  <div id="msg"></div>

  <table>
    <thead>
      <tr>
        <th>Truck ID</th>
        <th>Type</th>
        <th>Status</th>
        <th>Change Status</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

<script>
  const host = window.location.hostname || "127.0.0.1";
  const API = `http://${host}:8000`;

  const msgBox = document.getElementById("msg");
  function msg(text, kind="") {
    msgBox.className = kind;
    msgBox.textContent = text || "";
  }

  async function safeJson(res) {
    try { return await res.json(); } catch { return null; }
  }

  function getUpdated(truck) {
    return truck.updated_at || truck.updatedAt || truck.ts || truck.created_at || null;
  }

  async function refresh() {
    msg("");

    try {
      const res = await fetch(`${API}/api/owners/me/trucks`);
      const out = await safeJson(res);

      if (!res.ok) {
        msg(`Load failed (${res.status}): ${out?.detail || "Unknown error"}`, "err");
        return;
      }

      if (!Array.isArray(out)) {
        msg(`Unexpected response: ${JSON.stringify(out)}`, "err");
        return;
      }

      const tbody = document.getElementById("rows");
      tbody.innerHTML = "";

      if (out.length === 0) {
        msg("No trucks found for this owner.", "ok");
        return;
      }

      out.forEach(truck => {
        const updated = getUpdated(truck);
        const updatedText = updated ? new Date(updated).toLocaleString() : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${truck.truck_id}</td>
          <td>${truck.type}</td>
          <td><span class="badge">${truck.status}</span></td>
          <td>
            <select data-truck="${truck.truck_id}">
              <option value="available" ${truck.status === "available" ? "selected": ""}>available</option>
              <option value="out_of_service" ${truck.status === "out_of_service" ? "selected": ""}>out_of_service</option>
              <option value="unavailable" ${truck.status === "unavailable" ? "selected": ""}>unavailable</option>
            </select>
            <button data-save="${truck.truck_id}">Save</button>
          </td>
          <td>${updatedText}</td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll("button[data-save]").forEach(btn => {
        btn.onclick = async () => {
          const truckId = btn.dataset.save;
          const sel = document.querySelector(`select[data-truck="${truckId}"]`);
          const status = sel.value;

          const r = await fetch(`${API}/api/trucks/${truckId}`, {
            method: "PATCH",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ status })
          });

          const resp = await safeJson(r);

          if (!r.ok) {
            msg(`Update failed (${r.status}): ${resp?.detail || "Unknown error"}`, "err");
            return;
          }

          msg(`Updated ${truckId} â†’ ${status}`, "ok");
          refresh();
        };
      });

    } catch (e) {
      msg(
        `Network/CORS error while loading trucks.\n` +
        `Page: ${window.location.origin}\n` +
        `API: ${API}\n` +
        `Error: ${e.message}\n\n` +
        `Fix: open via http://localhost:5173/owner.html (NOT file://).`,
        "err"
      );
    }
  }

  document.getElementById("addBtn").onclick = async () => {
    const truck_id = document.getElementById("truckId").value.trim();
    const type = document.getElementById("truckType").value;
    const status = document.getElementById("truckStatus").value;

    if (!truck_id) { msg("truck_id required", "err"); return; }

    const res = await fetch(`${API}/api/owners/me/trucks`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ truck_id, type, status })
    });

    const out = await safeJson(res);

    if (!res.ok) {
      msg(`Add failed (${res.status}): ${out?.detail || "Unknown error"}`, "err");
      return;
    }

    msg(`Added ${out.truck_id}`, "ok");
    document.getElementById("truckId").value = "";
    refresh();
  };

  document.getElementById("refreshBtn").onclick = refresh;
  refresh();
</script>
</body>
</html>
